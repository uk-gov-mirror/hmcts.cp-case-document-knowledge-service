spring:
  application:
    name: cp-case-document-knowledge-service

  datasource:
    url: ${CP_CDK_DATASOURCE_URL}
    username: ${CP_CDK_DATASOURCE_USERNAME}
    password: ${CP_CDK_DATASOURCE_PASSWORD}
    hikari:
      pool-name: cp-hikari
      maximum-pool-size: ${CP_CDK_DB_POOL_SIZE:20}
      minimum-idle: ${CP_CDK_DB_MIN_IDLE:5}
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      keepalive-time: 300000
      validation-timeout: 5000

    jpa:
      open-in-view: false
      hibernate:
        ddl-auto: validate           # validate AFTER Flyway runs
      properties:
        hibernate.jdbc.time_zone: UTC
        hibernate.connection.provider_disables_autocommit: true
        hibernate.jdbc.batch_size: 50
        hibernate.order_inserts: true
        hibernate.order_updates: true

    flyway:
      enabled: true
      locations: classpath:db/migration
      baseline-on-migrate: false

  artemis:
    mode: native
    broker-url: ${CP_CDK_ARTEMIS_URL}

  jms:
    pub-sub-domain: true
    cache:
      session-cache-size: 5


server:
  port: ${SERVER_PORT:8082}
  shutdown: graceful
  http2:
    enabled: true
  forward-headers-strategy: framework   # honor X-Forwarded-* behind proxies
  compression:
    enabled: true
    min-response-size: 2KB
    mime-types: "application/json,application/xml,text/html,text/plain,text/xml,text/css,application/javascript"

management:

  # specifically disabling JMS health check due to library compatiblity issue with spring and artemis version
  health:
    jms:
      enabled: false
  server:
    # Keep actuator on same port by default; override if you want a separate port
    port: ${MANAGEMENT_SERVER_PORT:${SERVER_PORT:8082}}
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: "health,info,metrics,prometheus,env,loggers,threaddump"
  endpoint:
    health:
      probes:
        enabled: false                  # liveness/readiness groups
  metrics:
    tags:
      service: cp-case-document-knowledge-service
      cluster: ${CLUSTER_NAME:local}
      region: ${REGION:local}
  tracing:
    tracing:
      enabled: false
    sampling:
      probability: ${TRACING_SAMPLER_PROBABILITY:1.0}
  otlp:
    tracing:
      enabled: ${OTEL_METRICS_ENABLED:false}
      endpoint: ${OTEL_TRACES_URL:http://localhost:4318/traces}
    metrics:
      export:
        enabled: ${OTEL_METRICS_ENABLED:false}
        url: ${OTEL_METRICS_URL:http://localhost:4318/metrics}

logging:
  level:
    root: INFO
  config: classpath:logback-spring.xml

authz:
  http:
    enabled: false
    identity-url-template: "http://localhost:${server.port}/casedocumentknowledge-service/usersgroups-query-api/query/api/rest/usersgroups/users/logged-in-user/permissions"
    user-id-header: "CJSCPPUID"
    action-header: "CPP-ACTION"
    accept-header: "application/vnd.usersgroups.get-logged-in-user-permissions+json"
    drools-classpath-pattern: "classpath:/acl/**/*.drl"
    reload-on-each-request: true
    action-required: false
    deny-when-no-rules: true
    group-aliases:
      "Legal Advisers": "Legal Advisers"
      "Prosecuting Authority Access": "Prosecuting Authority Access"
    exclude-path-prefixes:
      - "/usersgroups-query-api/"
      - "/actuator"
      - "/error"
      - "/casedocumentknowledge-service/"

courtDocument:
  api:
    courtDocumentSearchUrlTemplate: "https://prosecuting.sit.cjscp.org.uk/api/progression-query-api/query/api/rest/progression/courtdocumentsearch?caseId={caseId}"
    actionHeader: "application/vnd.progression.query.courtdocuments+json"
    userIdHeader: "X-User-Id"

# Optional: Java 21 virtual threads (Boot 3.2+ / 4.x)
spring.threads.virtual.enabled: ${VIRTUAL_THREADS:false}

cp:
  audit:
    rest-spec: ${CP_CDK_REST_SPECIFICATION}